<!DOCTYPE html>

<head>
	<meta charset="utf-8" />
	<title>Kaguya Demo</title>
	<style>
		#app {
			width: 1800px;
			margin: 0 auto;
		}

		#msg-container {
			min-width: 100px;
			height: 800px;
			border-style: solid;
			border-width: 1px;
			margin: 10px auto;
			padding: 10px 10px 10px 10px;
			overflow: scroll;
		}

		#msg-container .self {
			text-align: right;
		}

		#msg-container .another {
			text-align: left;
		}

		#msg-input-box {
			float: right;
		}
	</style>
</head>

<body>
	<h2>Kaguya ES Demo</h2>
	<div id="app">
		<div id="msg-container">
		</div>
		<form id="msg-input-box">
			<input id="msg-input-box-target" type="text" />
			<input id="msg-input-box-data" type="text" />
			<input id="msg-input-box-submit" type="submit" disabled="disabled" />
		</form>
	</div>
	<script src="https://code.jquery.com/jquery-3.5.1.js"
		integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
	<script src="assets/js/compute/api.js"></script>
	<script>
		let client = new kaguyaAPI(
			"ws://localhost:10101/"
		);

		let actions = [];

		client.setOnMessageHandle(function (msg) {
			msgData = JSON.parse(msg.data);
			switch (msgData.actionType) {
				case "authService":
					switch (msgData.action) {
						case "getAccess":
							client.identity = msgData.data;
							if (client.identity != "") {
								$("#msg-container").html('');
								$("#msg-input-box-submit").attr("disabled", false);
							} else {
								$("#msg-input-box-submit").attr("disabled", true);
							}
							break;
					}
					break;
				case "talkService":
					let msgOrigin = actions.includes(msgData.actionID) ? "self" : "another";
					$("#msg-container").append('<div class="' + msgOrigin +
						'"><h3 class="name">System:</h3><p>' + atob(msgData.data.content) +
						'</p></div>');
					break;
			}
		});

		$("#msg-input-box").submit(
			function (e) {
				e.preventDefault();
				let actionID = client.sendTextMessage(0, $("#msg-input-box-target").val(), $("#msg-input-box-data")
			.val());
				actions.push(actionID);
				$("#msg-input-box-data").val("");
				$("#msg-container").animate({
					scrollTop: $("#msg-container").prop('scrollHeight')
				}, 100);
			}
		);

		$(function () {
			if (client.identity != "") {
				$("#msg-input-box-submit").attr("disabled", false);
			} else {
				$("#msg-container").html(
					'<form id="login-box"><input id="login-id" type="text" /><input id="login-pw" type="text" /><input id="login-box-submit" type="submit" /></form>'
				);
				$("#login-box").submit(
					function (e) {
						e.preventDefault();
						client.getAccess($("#login-id").val(), $("#login-pw").val());
					}
				);
			}
		});
	</script>
</body>

</html>